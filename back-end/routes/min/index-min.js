var express=require("express"),router=express.Router(),mongoose=require("mongoose"),mongoUrl="mongodb://localhost:27017/ecommerce",User=require("../models/user_model.js");mongoose.connect(mongoUrl);var bcrypt=require("bcrypt-nodejs"),randToken=require("rand-token").uid,config=require("../config/config"),stripe=require("stripe")(config.secretTestKey);router.get("/",function(e,o,s){o.render("index",{title:"Express"})}),router.post("/register",function(e,o,s){User.findOne({username:e.body.username},function(s,n){if(n===e.body.username)e.body.password!==e.body.password2?o.json({message:"no match",taken:"inUse"}):o.json({taken:"inUse"});else if(e.body.password!==e.body.password2)o.json({message:"no match"});else{var r=e.body.username,t=e.body.password,u=e.body.email,a=randToken(32),d=Date.now(),c=new User({username:r,password:bcrypt.hashSync(t),email:u,token:a});c.save(function(e,s){e?o.json({message:"errorAdding"}):o.json({message:"User Added",username:r,token:a})})}})}),router.post("/login",function(e,o,s){User.findOne({username:e.body.username},function(s,n){if(null===n)o.json({failure:"noUser"});else{var r=bcrypt.compareSync(e.body.password,n.password),t=randToken(32),u=Date.now();r?(User.update({username:n.username},{token:t,tokenExpDate:u}).exec(),o.json({success:"userFound",username:n.username,token:t,tokenExpDate:u})):o.json({failure:"badPass"})}})}),router.get("/getUserData",function(e,o,s){var n=e.query.token;void 0===n?o.json({failure:"noToken"}):User.findOne({token:n},function(e,s){null===s?o.json({failure:"badToken"}):o.json({document:s,username:s.username,grind:s.grind,frequency:s.frequency,token:s.token})}),router.get("/options",function(e,o,s){o.json({message:"success"})})}),router.post("/options",function(e,o,s){User.update({username:e.body.username},{frequency:e.body.frequency,amount:e.body.amount,weeklyTotal:e.body.weeklyTotal,grindType:e.body.grindType}).exec(),console.log("hello"),o.json({message:"updated"})}),router.post("/delivery",function(e,o,s){User.update({username:e.body.username},{fullName:e.body.fullName,address:e.body.address}).exec(),o.json({message:"success",document:User})}),router.get("/payment",function(e,o,s){o.json({message:"connected"})}),router.post("/stripe",function(e,o,s){stripe.charges.create({amount:e.body.amount,currency:"usd",source:e.body.stripeToken}).then(function(e){o.json({message:"successCharge",success:"Yess!"})},function(e){o.json({message:"errorCharge",error:e})})}),module.exports=router;