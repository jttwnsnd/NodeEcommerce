var express=require("express"),router=express.Router(),mongoose=require("mongoose"),mongoUrl="mongodb://localhost:27017/ecommerce",User=require("../models/user_model.js");mongoose.connect(mongoUrl);var bcrypt=require("bcrypt-nodejs"),randToken=require("rand-token").uid;router.get("/",function(e,n,o){n.render("index",{title:"Express"})}),router.post("/register",function(e,n,o){User.findOne({username:e.body.username},function(o,s){if(s===e.body.username)e.body.password!==e.body.password2?n.json({message:"no match",taken:"inUse"}):n.json({taken:"inUse"});else if(e.body.password!==e.body.password2)n.json({message:"no match"});else{var r=e.body.username,a=e.body.password,t=e.body.email,u=randToken(32),d=Date.now(),i=new User({username:r,password:bcrypt.hashSync(a),email:t,token:u});i.save(function(e,o){e?n.json({message:"errorAdding"}):n.json({message:"User Added",username:r,token:u})})}})}),router.post("/login",function(e,n,o){User.findOne({username:e.body.username},function(o,s){if(null===s)n.json({failure:"noUser"});else{var r=bcrypt.compareSync(e.body.password,s.password),a=randToken(32),t=Date.now();r?(User.update({username:s.username},{token:a,tokenExpDate:t}).exec(),n.json({success:"userFound",username:s.username,token:a,tokenExpDate:t})):n.json({failure:"badPass"})}})}),router.get("/getUserData",function(e,n,o){var s=e.query.token;void 0===s?n.json({failure:"noToken"}):User.findOne({token:s},function(e,o){null===o?n.json({failure:"badToken"}):n.json({username:o.username,grind:o.grind,frequency:o.frequency,token:o.token})}),router.get("/options",function(e,n,o){n.json({message:"success"})})}),module.exports=router;