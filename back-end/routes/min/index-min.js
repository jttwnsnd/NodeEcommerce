var express=require("express"),router=express.Router(),mongoose=require("mongoose"),mongoUrl="mongodb://localhost:27017/ecommerce",User=require("../models/user_model.js");mongoose.connect(mongoUrl);var bcrypt=require("bcrypt-nodejs"),randToken=require("rand-token");router.get("/",function(e,n,o){n.render("index",{title:"Express"})}),router.post("/register",function(e,n,o){User.findOne({username:e.body.username},function(o,r){if(r===e.body.username)e.body.password!==e.body.password2?n.json({message:"no match",taken:"inUse"}):n.json({taken:"inUse"});else if(e.body.password!==e.body.password2)n.json({message:"no match"});else{var s=e.body.username,a=e.body.password,t=e.body.email,u=randToken(32),d=Date.now(),i=new User({username:s,password:bcrypt.hashSync(a),email:t,token:u});i.save(function(e,o){e?n.json({message:"errorAdding"}):n.json({message:"User Added",username:s,token:u})})}})}),router.post("/login",function(e,n,o){User.findOne({username:e.body.username},function(o,r){if(null===r)n.json({failure:"noUser"});else{var s=bcrypt.compareSync(e.body.password,r.password),a=randToken(32),t=Date.now();s?n.json({success:"userFound",username:r.username,token:a}):n.json({failure:"badPass"}),User.update({username:r.username},{token:a,tokenExpDate:t})}})}),router.get("getUserData",function(e,n,o){var r=e.query.token;void 0===r?n.json({failure:"noToken"}):User.findOne({token:r},function(e,o){null===o?n.json({failure:"badToken"}):n.json({username:o.username,grind:o.grind,frequency:o.frequency,token:o.token})})}),module.exports=router;